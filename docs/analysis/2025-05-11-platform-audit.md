# 2025-05-11 — Комплексный аудит платформы Kyanchir

## Executive Summary
- Витрина и каталог построены на Next.js App Router, но рендерятся `force-dynamic` и каждый раз запрашивают весь ассортимент без кеша, что даёт линейный рост нагрузки на Prisma при расширении каталога.【F:src/app/(site)/page.tsx†L8-L90】【F:src/app/(site)/catalog/page.tsx†L7-L70】
- Флоу оформления заказа устойчив: API валидирует данные через Zod, пересчитывает остатки и создаёт заказ в транзакции, но платёжка ЮKassa всё ещё завязана на отсутствующие production-ключи.【F:src/app/api/orders/route.ts†L9-L243】【F:src/lib/payments/yookassa.ts†L1-L198】
- Админские сценарии опираются на Prisma и внешние интеграции (МойСклад, Telegram), но некоторые эндпоинты всё ещё работают без транзакций и централизованного логирования.【F:src/app/api/admin/products/update-stock/route.ts†L15-L53】【F:src/lib/moysklad-api.ts†L1-L200】

## Архитектура фронтенда
- Публичные страницы (`/(site)`) собирают данные напрямую из Prisma, что упрощает код, но требует внедрения лимитов, фильтров и кеширующих стратегий (`unstable_cache`/ISR), чтобы выдерживать рост каталога.【F:src/app/(site)/page.tsx†L8-L90】【F:src/app/(site)/catalog/page.tsx†L7-L70】
- Админка разнесена по сегментам App Router; например, конструктор дизайн-системы обновляет CSS-токены через серверные действия, что упрощает синхронизацию с публичной частью.【F:src/app/admin/settings/design-system/page.tsx†L1-L74】
- Клиентские компоненты включаются только при необходимости: checkout помечен `'use client'`, но критическая логика вынесена в стораджи и утилиты, что помогает держать bundle компактным.【F:src/app/(site)/checkout/page.tsx†L1-L200】【F:src/store/useCartStore.ts†L1-L141】

## API и серверная логика
- Эндпоинт `/api/orders` демонстрирует желаемый стандарт: строгая Zod-валидация, проверка остатков, транзакционное создание заказа и уменьшение стоков, плюс интеграция с платёжным шлюзом при наличии конфигурации.【F:src/app/api/orders/route.ts†L9-L243】
- Админский `update-stock` по-прежнему синхронизирует МойСклад и Prisma отдельными вызовами без `$transaction` и retry-логики — при сетевых сбоях данные могут рассинхронизироваться.【F:src/app/api/admin/products/update-stock/route.ts†L15-L53】
- Модуль `src/lib/monitoring.ts` пока собирает события в памяти и выводит их в консоль; его нужно расширять до полноценного адаптера для Sentry/Logtail, чтобы иметь трассировку проблем в проде.【F:src/lib/monitoring.ts†L1-L38】

## Данные и интеграции
- Prisma-схема покрывает продукты, заказы, статусы, пользователи и системные настройки, что позволяет хранить ключи интеграций в базе, а не в конфиге.【F:prisma/schema.prisma†L14-L200】
- ЮKassa-интеграция формирует фискальный чек, нормализует телефоны и использует idempotence-key, однако без заполненных `YOOKASSA_*` переменных платежи не стартуют.【F:src/lib/payments/yookassa.ts†L55-L198】【F:docs/SECURITY_AUDIT.md†L23-L51】
- МойСклад-обёртка кеширует API-ключ и дефолтные справочники, но логирует ошибки только в консоль — стоит добавить structured logging и оповещения.【F:src/lib/moysklad-api.ts†L16-L145】
- Cron-гайд подчёркивает необходимость сервисного токена: текущая реализация требует админской сессии, что мешает безопасным автоматическим запускам.【F:docs/operations/cron.md†L1-L12】

## Клиентские флоу и UX
- Сторадж `useCartStore` централизует корзину, следит за количеством и мигрирует данные между версиями, что защищает от битых записей в localStorage.【F:src/store/useCartStore.ts†L1-L141】
- Checkout очищает корзину после успешного заказа, показывает итог и ссылки на оплату/ошибку, а также отправляет toast-уведомления через общий UI-store.【F:src/app/(site)/checkout/page.tsx†L78-L200】
- Карточка товара учитывает остатки и умеет перенаправлять в тестовый платёжный флоу, если включён `NEXT_PUBLIC_TEST_PAYMENT_URL`, что полезно для демонстраций без полного checkout.【F:src/components/ProductDetails.tsx†L329-L376】

## Тесты и наблюдаемость
- Тестовый контур покрывает только базовые UI- и утилитные сценарии; используется `node:test` и `react-dom/server` для проверки серверного рендера компонентов — требуется расширить покрытие корзины/checkout.【F:tests/ui-components.test.tsx†L1-L29】
- Есть минимальные проверки очереди мониторинга и измерения производительности, которые нужно развивать по мере внедрения централизованного логгера.【F:tests/lib-utils.test.ts†L1-L32】【F:src/lib/performance.ts†L1-L38】
- Мониторинг и алертинг пока отсутствуют: события лишь накапливаются в памяти и печатаются в консоль, поэтому критические ошибки незаметны без ручного просмотра логов.【F:src/lib/monitoring.ts†L1-L38】

## Tooling и Developer Experience
- Билд-пайплайн оборачивает `npm run test`, деплой миграций и `next build` в единый скрипт `scripts/build-with-quality-checks.mjs`, сохраняя отчёты в `data/build-reports.json` — удобно для анализа времени сборки.【F:scripts/build-with-quality-checks.mjs†L1-L170】
- Линт и форматирование запускаются через `npm run lint`, но проверку типов (`tsc --noEmit`) и анализ зависимостей нужно запускать вручную — добавлены команды `npm run typecheck`, `npm run analyze:deps` и `npm run analyze:graph`, чтобы закрыть этот пробел.【F:package.json†L7-L29】【F:package.json†L36-L86】
- Playwright-скрипт для скриншотов остаётся актуальным инструментом визуального контроля; его стоит использовать перед крупными UI-изменениями.【F:scripts/capture-screenshot.ts†L1-L117】

## Приоритетный план улучшений
1. **Оптимизация витрины**: ввести пагинацию и кеширование запросов продуктов, чтобы снизить время ответа и нагрузку на БД.【F:src/app/(site)/page.tsx†L8-L90】【F:src/app/(site)/catalog/page.tsx†L7-L70】
2. **Checkout 2.0**: подключить боевые ключи ЮKassa, добавить уведомления (email/Telegram) и покрыть платёжные сценарии тестами.【F:src/app/api/orders/route.ts†L167-L243】【F:src/lib/payments/yookassa.ts†L135-L198】
3. **Админский sync**: переписать `update-stock` на транзакции с централизованным логированием и выделенным сервисным токеном для cron-задач.【F:src/app/api/admin/products/update-stock/route.ts†L15-L53】【F:docs/operations/cron.md†L1-L12】
4. **Наблюдаемость**: внедрить адаптер для Sentry/Logtail поверх `monitoring.ts` и расширить performance-метрики для ключевых API.【F:src/lib/monitoring.ts†L1-L38】【F:src/lib/performance.ts†L1-L38】

## Быстрые победы (Quick Wins)
- Подключить `unstable_cache` или `cache()` вокруг запросов Prisma на главной/каталоге и ограничить выборку до первых 20 товаров, добавив кнопку «Загрузить ещё».【F:src/app/(site)/page.tsx†L8-L90】
- Добавить unit-тест на happy-path оформления заказа, мокируя Prisma и YooKassa, чтобы зафиксировать контракт `/api/orders`.【F:src/app/api/orders/route.ts†L9-L243】
- Расширить `monitoring.logError` сохранением дополнительного контекста (orderId, пользователь, интеграция), чтобы в дальнейшем быстро подключить внешний логгер.【F:src/lib/monitoring.ts†L22-L34】
